"use strict";(self.webpackChunkwai=self.webpackChunkwai||[]).push([[8422],{27225:(t,e,a)=>{a.d(e,{Co:()=>S,X9:()=>Z,ft:()=>_,wH:()=>M});var s=a(33555),i=a(6137),n=a(91713),o=a(83716),r=a(71226),d=a(25260),c=a(11192),l=a(60782),u=a(69118),h=a(56112),p=a(53551),g=a(78958),I=a(42431),f=a(16974),m=a(50711),w=a(9211),b=a(44271),C=a(65054),y=a(60054),V=a(21591);o.awM;const v=(0,u.P2)((t=>t()),3e3,!0),R=(0,u.Ds)((t=>t()),500,!1,!0);function M(t){const e=(0,s.Rd)();return e.users.byId[t]&&e.users.byId[t].fullInfo?{bot:e.users.byId[t].bot,botInfo:e.users.byId[t].fullInfo.botInfo}:void 0}async function D(t,e,a,n,r=!1,u){t=(0,s.Rd)();let h=(0,c.VF)(t)?.message;try{let n;if(t.users.byId[y.gg])return t={...t,chats:{...t.chats,isFullyLoaded:{...t.chats.isFullyLoaded,[e]:!0}}},void(0,s.R3)(t);n=y.H8;for(let e=0;e<n.chats.length;e++){const a=n.chats[e];if(t.messages.byChatId[a.id]){const{threadsById:s,byId:i}=t.messages.byChatId[a.id];s[-1]&&s[-1].lastViewportIds&&s[-1].lastViewportIds.length>0&&(n.chats[e].lastMessage=i[s[-1].lastViewportIds[s[-1].lastViewportIds.length-1]])}}const p={};n.users.forEach((t=>{p[t.id]={type:"userStatusEmpty"}})),n.userStatusesById=p,t=(0,s.Rd)(),n.chatIds=n.chats.map((t=>t.id));const{chatIds:g}=n;g.length>0&&g[0]===a&&g.shift(),n.totalChatCount=n.chats.length,h=(0,c.VF)(t)?.message;const I={};n.chatFolders?.forEach((t=>{I[t.id]=t}));const f=n.chatFolders&&n.chatFolders.length>0?n.folderIds:[0];if(t={...t,chatFolders:{byId:{...I},orderedIds:f}},r&&"active"===e&&"connectionStateLogged"===t.msgClientState){const a=Object.values(t.byTabId),s=a.flatMap((({id:e})=>{const a=(0,c.jr)(t,e);return a?[a]:[]})),i=a.flatMap((({id:e})=>(0,c.P2)(t,e)||[]));t.currentUserId&&t.users.byId[t.currentUserId]&&i.push(t.users.byId[t.currentUserId]),t=(0,d.s5)(t,(0,l.ee)(i.concat(n.users),"id")),t=(0,d.ps)(t,n.userStatusesById),t=(0,d.SL)(t,(0,l.ee)(s.concat(n.chats),"id")),t=(0,d.B1)(t,e,g)}else if(r&&"archived"===e&&"connectionStateLogged"===t.msgClientState)t=(0,d.Sh)(t,(0,l.ee)(n.users,"id")),t=(0,d.zn)(t,n.userStatusesById),t=(0,d.GL)(t,(0,l.ee)(n.chats,"id")),t=(0,d.Mg)(t,e,g);else{const a=(0,l.ee)(n.chats,"id");if(g.includes(o.awM)){const t=a[o.awM];t&&h&&(a[o.awM]={...t,lastMessage:h})}t=(0,d.Sh)(t,(0,l.ee)(n.users,"id")),t=(0,d.zn)(t,n.userStatusesById),t=(0,d.GL)(t,a),t=(0,d.B1)(t,e,g)}t=(0,d.vv)(t,e,n),(u?n.chatIds:Object.keys(n.draftsById)).forEach((e=>{const a=n.draftsById[e],s=(0,c.ci)(t,e,i._f);(a||s)&&((0,c.Ms)(t,e,i._f)?.isLocal||(t=(0,d.pf)(t,e,i._f,"draft",a)))})),(u?n.chatIds:Object.keys(n.replyingToById)).forEach((e=>{const a=n.replyingToById[e],s=(0,c.ci)(t,e,i._f);(a||s)&&(t=(0,d.pf)(t,e,i._f,"replyingToId",a))})),t={...t,chats:{...t.chats,isFullyLoaded:{...t.chats.isFullyLoaded,[e]:!0}}},(0,s.R3)(t)}catch(t){console.error(t)}}async function _(t,e,a,...[i=(0,C._w)()]){const n=await(0,r.t9)("fetchFullChat",a);if(!n)return;const{users:o,userStatusesById:c,fullInfo:u,groupCall:h,membersCount:p}=n;if(t=(0,s.Rd)(),o&&(t=(0,d.Sh)(t,(0,l.ee)(o,"id"))),c&&(t=(0,d.zn)(t,c)),h){const e=(0,I.$5)(t,h.id);t=(0,g.AH)(t,h.id,(0,l.CE)(h,["connectionState"]),void 0,e?void 0:h.participantsCount)}t=(0,d.a4)(t,a.id,{fullInfo:u,...p&&{membersCount:p}}),(0,s.R3)(t);const f=u.stickerSet;return f&&e.loadStickers({stickerSetInfo:{id:f.id,accessHash:f.accessHash},tabId:i}),n}async function S(t,e){t=(0,s.Rd)();const a=(0,c.DI)(t,e);if(a&&!a.isMin)return a;const{chat:i,user:n}=await(0,r.t9)("getChatByUsername",e)||{};return i?(t=(0,s.Rd)(),t=(0,d.a4)(t,i.id,i),n&&(t=(0,d.Nq)(t,n.id,n)),(0,s.R3)(t),i):void 0}async function A(t,e,a,...[i=(0,C._w)()]){const n=await S(t,a);if(!n)return;t=(0,s.Rd)();const o=(0,c.dy)(t,n.id);if(!o)return;if(!(0,h.cS)(o))return;const u=await(0,r.t9)("loadAttachBot",{bot:o});if(t=(0,s.Rd)(),u)return t=(0,d.Sh)(t,(0,l.ee)(u.users,"id")),(0,s.R3)(t),u.bot;e.showNotification({message:m.Iu("WebApp.AddToAttachmentUnavailableError"),tabId:i})}async function P(t,e,a,i,n,...[o=(0,C._w)()]){t=(0,s.Rd)();const r=await A(t,e,i,o);r&&e.callAttachBot({bot:r,chatId:a,..."string"==typeof n&&{startParam:n},tabId:o})}async function Z(t,e,a,...[s=(0,C._w)()]){const i=(0,c.Z1)(t,a);if(!i||!(0,h.G9)(i))return i;const n=await async function(t,e,a,...[s=(0,C._w)()]){try{return await(0,r.t9)("migrateChat",a)}catch(t){return void("CHANNELS_TOO_MUCH"===t.message?e.openLimitReachedModal({limit:"channels",tabId:s}):e.showDialog({data:{...t,hasErrorKey:!0},tabId:s}))}}(0,e,i,s);return n?(e.openChat({id:n.id,tabId:s}),n):void 0}(0,s.iw)("preloadTopChatMessages",(async(t,e)=>{const a=new Set;for(let n=0;n<o.ulj;n++){await(0,u.wO)(100),t=(0,s.Rd)();const n=Object.values(t.byTabId).map((({id:e})=>(0,c.Bt)(t,e)?.chatId)).filter(Boolean),r=(0,f.gO)(o.NfV),d=r?.find((t=>!n.includes(t)&&!a.has(t)));if(!d)return;a.add(d),e.loadViewportMessages({chatId:d,threadId:i._f,tabId:(0,C._w)()})}})),(0,s.iw)("openChat",((t,e,a)=>{const{id:s,threadId:n=i._f}=a;if(!s)return;const{currentUserId:o}=t,d=(0,c.Z1)(t,s);if(d?.hasUnreadMark&&e.toggleChatUnread({id:s}),d)(0,h.Hp)(d)&&d.isMin;else if(s===o)(0,r.t9)("fetchChat",{type:"self"});else{const e=(0,c.dy)(t,s);e&&(0,r.t9)("fetchChat",{type:"user",user:e})}n!==i._f&&e.requestThreadInfoUpdate({chatId:s,threadId:n})})),(0,s.iw)("openComments",(async(t,e,a)=>{const{id:n,threadId:u,originChannelId:h,tabId:p=(0,C._w)()}=a;if(u!==i._f){const a=(0,c.qS)(t,n,u);if(a)e.openChat({id:n,threadId:a,tabId:p});else{const a=(0,c.Cm)(t,n,u);if(!a)return;e.openChat({id:o.mzl,tabId:p});const i=await(0,r.t9)("requestThreadInfoUpdate",{chat:a,threadId:u,originChannelId:h});if(!i)return void e.openPreviousChat({tabId:p});t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(i.users,"id")),(0,s.R3)(t),e.openChat({id:n,threadId:i.topMessageId,tabId:p})}}})),(0,s.iw)("openLinkedChat",(async(t,e,a)=>{const{id:s,tabId:i=(0,C._w)()}=a,n=(0,c.Z1)(t,s);if(!n)return;const o=await(0,r.t9)("fetchFullChat",n);o?.fullInfo?.linkedChatId&&e.openChat({id:o.fullInfo.linkedChatId,tabId:i})})),(0,s.iw)("focusMessageInComments",(async(t,e,a)=>{const{chatId:i,threadId:n,messageId:o,tabId:u=(0,C._w)()}=a,h=(0,c.Z1)(t,i);if(!h)return;const p=await(0,r.t9)("requestThreadInfoUpdate",{chat:h,threadId:n});p&&(t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(p.users,"id")),(0,s.R3)(t),e.focusMessage({chatId:i,threadId:n,messageId:o,tabId:u}))})),(0,s.iw)("openSupportChat",(async(t,e,a)=>{const{tabId:s=(0,C._w)()}=a||{},i=(0,c.P_)(t);if(i)return void e.openChat({id:i.id,shouldReplaceHistory:!0,tabId:s});e.openChat({id:o.mzl,shouldReplaceHistory:!0,tabId:s});const n=await(0,r.t9)("fetchChat",{type:"support"});n&&e.openChat({id:n.chatId,shouldReplaceHistory:!0,tabId:s})})),(0,s.iw)("loadAllChats",(async(t,e,a)=>{const i=a.listType;if("archived"===i)return;const{onReplace:n}=a;let{shouldReplace:r}=a,d=0;const l=t=>t.lastMessage?.date||t.joinDate;for(;r||!t.chats.isFullyLoaded[i];){if(d++>=100)return void(o.eMD&&console.error("`actions/loadAllChats`: Infinite loop detected"));if("connectionStateLogged"!==(t=(0,s.Rd)()).msgClientState&&"connectionStateWaitingLogin"!==t.msgClientState&&"connectionStateConnected"!==t.msgClientState)return;const e=!r&&t.chats.listIds[i],a=e?e.map((e=>t.chats.byId[e])).filter((e=>Boolean(e&&l(e))&&e.id!==o.awM&&!(0,c.ep)(t,e.id))).sort(((t,e)=>l(t)-l(e)))[0]:void 0;await D(t,i,a?.id,a&&l(a),r,!0),r&&(n?.(),r=!1),t=(0,s.Rd)()}})),(0,s.iw)("loadFullChat",((t,e,a)=>{const{chatId:s,force:i,tabId:n=(0,C._w)()}=a,o=(0,c.Z1)(t,s);o&&(i?_(t,e,o,n):R((()=>_(t,e,o,n))))})),(0,s.iw)("loadTopChats",(t=>{v((()=>D(t,"active")))})),(0,s.iw)("requestChatUpdate",((t,e,a)=>{const{chatId:s}=a,i=(0,c.Z1)(t,s);i&&(0,r.t9)("requestChatUpdate",{chat:i,...s===o.awM&&{lastLocalMessage:(0,c.VF)(t)?.message}})})),(0,s.iw)("updateChatMutedState",((t,e,a)=>{const{chatId:i,isMuted:n}=a,o=(0,c.Z1)(t,i);o&&(t=(0,d.a4)(t,i,{isMuted:n}),(0,s.R3)(t),(0,r.t9)("updateChatMutedState",{chat:o,isMuted:n}))})),(0,s.iw)("updateTopicMutedState",((t,e,a)=>{const{chatId:i,isMuted:n,topicId:o}=a,l=(0,c.Z1)(t,i);l&&(t=(0,d.Cn)(t,i,o,{isMuted:n}),(0,s.R3)(t),(0,r.t9)("updateTopicMutedState",{chat:l,topicId:o,isMuted:n}))})),(0,s.iw)("createChannel",(async(t,e,a)=>{const{title:i,about:o,photo:l,memberIds:u,tabId:h=(0,C._w)()}=a,p=u.map((e=>(0,c.dy)(t,e))).filter(Boolean);let g;t=(0,b.i)(t,{chatCreation:{progress:n.Nh.InProgress}},h),(0,s.R3)(t);try{g=await(0,r.t9)("createChannel",{title:i,about:o,users:p})}catch(a){t=(0,s.Rd)(),t=(0,b.i)(t,{chatCreation:{progress:n.Nh.Error}},h),(0,s.R3)(t),"CHANNELS_TOO_MUCH"===a.message?e.openLimitReachedModal({limit:"channels",tabId:h}):e.showDialog({data:{...a,hasErrorKey:!0},tabId:h})}if(!g)return;const{id:I,accessHash:f}=g;t=(0,s.Rd)(),t=(0,d.a4)(t,I,g),t=(0,b.i)(t,{chatCreation:{...(0,c.jU)(t,h).chatCreation,progress:g?n.Nh.Complete:n.Nh.Error}},h),(0,s.R3)(t),e.openChat({id:I,shouldReplaceHistory:!0,tabId:h}),I&&f&&l&&await(0,r.t9)("editChatPhoto",{chatId:I,accessHash:f,photo:l})})),(0,s.iw)("joinChannel",(async(t,e,a)=>{const{chatId:s,tabId:i=(0,C._w)()}=a,n=(0,c.Z1)(t,s);if(!n)return;const{id:o,accessHash:d}=n;if(o&&d)try{await(0,r.t9)("joinChannel",{channelId:o,accessHash:d})}catch(t){"CHANNELS_TOO_MUCH"===t.message?e.openLimitReachedModal({limit:"channels",tabId:i}):e.showDialog({data:{...t,hasErrorKey:!0},tabId:i})}})),(0,s.iw)("deleteChatUser",((t,e,a)=>{const{chatId:i,userId:n,tabId:o=(0,C._w)()}=a,l=(0,c.Z1)(t,i),u=(0,c.dy)(t,n);l&&u&&(t=(0,d.Dd)(t,i),(0,s.R3)(t),(0,c.Bt)(t,o)?.chatId===i&&e.openChat({id:void 0,tabId:o}),(0,r.t9)("deleteChatUser",{chat:l,user:u}))})),(0,s.iw)("deleteChat",((t,e,a)=>{const{chatId:i,tabId:n=(0,C._w)()}=a,o=(0,c.Z1)(t,i);o&&(t=(0,d.Dd)(t,i),(0,s.R3)(t),(0,c.Bt)(t,n)?.chatId===i&&e.openChat({id:void 0,tabId:n}),(0,r.t9)("deleteChat",{chatId:o.id}))})),(0,s.iw)("leaveChannel",((t,e,a)=>{const{chatId:i,tabId:n=(0,C._w)()}=a,o=(0,c.Z1)(t,i);if(!o)return;t=(0,d.Dd)(t,i),(0,s.R3)(t),(0,c.Bt)(t,n)?.chatId===i&&e.openChat({id:void 0,tabId:n});const{id:l,accessHash:u}=o;l&&u&&(0,r.t9)("leaveChannel",{channelId:l,accessHash:u})})),(0,s.iw)("deleteChannel",((t,e,a)=>{const{chatId:i,tabId:n=(0,C._w)()}=a,o=(0,c.Z1)(t,i);if(!o)return;t=(0,d.Dd)(t,i),(0,s.R3)(t),(0,c.Bt)(t,n)?.chatId===i&&e.openChat({id:void 0,tabId:n});const{id:l,accessHash:u}=o;l&&u&&(0,r.t9)("deleteChannel",{channelId:l,accessHash:u})})),(0,s.iw)("createChat",(async(t,e,a)=>{const{title:i,about:o,tabId:r=(0,C._w)()}=a;t=(0,b.i)(t,{chatCreation:{progress:n.Nh.InProgress}},r),(0,s.R3)(t);try{const a=Object.keys(t.users.byId);let u=y.gg+1;a.length>0&&(a.sort(((t,e)=>parseInt(e)-parseInt(t))),u=a[0]+1);const h={canBeInvitedToGroup:!1,hasVideoAvatar:!1,type:"userTypeBot",id:u,phoneNumber:"",isMin:!1,noStatus:!0,isSelf:!1,avatarHash:"",accessHash:"",isPremium:!1,firstName:i,photos:[],usernames:[{username:"Bot_"+u,isActive:!0,isEditable:!0}],fullInfo:{isBlocked:!1,noVoiceMessages:!1,bio:o||y.GX,botInfo:{config:{enableAi:!0,chatGptConfig:{init_system_content:"",api_key:"",max_history_length:10,config:y.ep}},botId:u,description:o||y.GX,menuButton:{type:"commands"},commands:y.Jw.map((t=>(t.botId=u,t)))}}};t=(0,s.Rd)();const{chatFolders:p}=t,g=[h],I=[V.Z.buildDefaultChat(h)];let f,m=window.sessionStorage.getItem("activeChatFolder");const w={};m&&Object.values(p.byId).forEach((t=>{t.id===parseInt(m)&&(f=t,t.includedChatIds||(t.includedChatIds=[]),t.includedChatIds.push(u),w[t.id]=t)}));const C={[h.id]:{type:"userStatusEmpty"}};t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(g,"id")),t=(0,d.fZ)(t,(0,l.ee)(I,"id")),t=(0,d.B1)(t,"active",I.map((t=>t.id))),t=(0,d.zn)(t,C),t=(0,b.i)(t,{chatCreation:{...(0,c.jU)(t,r).chatCreation,progress:n.Nh.Complete}},r),(0,s.R3)({...t,chatFolders:{...t.chatFolders,byId:{...t.chatFolders.byId,...w}}}),f&&e.editChatFolder({id:f.id,folderUpdate:f}),e.openChat({id:u,shouldReplaceHistory:!0})}catch(e){console.error(e),t=(0,s.Rd)(),t=(0,b.i)(t,{chatCreation:{...(0,c.jU)(t,r).chatCreation,progress:n.Nh.Error,error:"创建失败"}},r),(0,s.R3)(t)}})),(0,s.iw)("createGroupChat",(async(t,e,a)=>{const{title:i,memberIds:o,photo:l,tabId:u=(0,C._w)()}=a,h=o.map((e=>(0,c.dy)(t,e))).filter(Boolean);t=(0,b.i)(t,{chatCreation:{progress:n.Nh.InProgress}},u),(0,s.R3)(t);try{const a=await(0,r.t9)("createGroupChat",{title:i,users:h});if(!a)return;const{id:o}=a;t=(0,s.Rd)(),t=(0,d.a4)(t,o,a),t=(0,b.i)(t,{chatCreation:{...(0,c.jU)(t,u).chatCreation,progress:a?n.Nh.Complete:n.Nh.Error}},u),(0,s.R3)(t),e.openChat({id:o,shouldReplaceHistory:!0,tabId:u}),o&&l&&await(0,r.t9)("editChatPhoto",{chatId:o,photo:l})}catch(e){"USERS_TOO_FEW"===e.message&&(t=(0,s.Rd)(),t=(0,b.i)(t,{chatCreation:{...(0,c.jU)(t,u).chatCreation,progress:n.Nh.Error,error:"CreateGroupError"}},u),(0,s.R3)(t))}})),(0,s.iw)("toggleChatPinned",((t,e,a)=>{const{id:s,folderId:i,tabId:n=(0,C._w)()}=a,d=(0,c.Z1)(t,s);if(!d)return;const l=(0,w.M)(t,"dialogFolderPinned");if(i){const e=(0,c.Mw)(t,i);if(e){const a=!(0,c.ep)(t,s,i),{pinnedChatIds:n,includedChatIds:o}=e,d=a?[s,...n||[]]:(n||[]).filter((t=>t!==s)),l=[s,...o];(0,r.t9)("editChatFolder",{id:i,folderUpdate:{...e,pinnedChatIds:d,includedChatIds:l}})}}else{const a=(0,c.Ek)(t,s),i=(0,c.ep)(t,s,"archived"===a?o.WSp:void 0),u=t.chats.orderedPinnedIds["archived"===a?"archived":"active"];if((u?.length||0)>=l&&!i)return void e.openLimitReachedModal({limit:"dialogFolderPinned",tabId:n});(0,r.t9)("toggleChatPinned",{chat:d,shouldBePinned:!i})}})),(0,s.iw)("toggleChatArchived",((t,e,a)=>{const{id:s}=a,i=(0,c.Z1)(t,s);i&&(0,r.t9)("toggleChatArchived",{chat:i,folderId:(0,h.pE)(i)?0:o.WSp})})),(0,s.iw)("loadChatFolders",(async t=>{const e=await(0,r.t9)("fetchChatFolders");e&&(t=(0,s.Rd)(),t={...t,chatFolders:{...t.chatFolders,...e}},(0,s.R3)(t))})),(0,s.iw)("loadRecommendedChatFolders",(async t=>{const e=await(0,r.t9)("fetchRecommendedChatFolders");e&&(t=(0,s.Rd)(),t={...t,chatFolders:{...t.chatFolders,recommended:e}},(0,s.R3)(t))})),(0,s.iw)("editChatFolders",((t,e,a)=>{const{chatId:s,idsToRemove:i,idsToAdd:n,tabId:o=(0,C._w)()}=a,d=(0,w.M)(t,"dialogFiltersChats");n.some((e=>(0,c.Mw)(t,e).includedChatIds.length>=d))?e.openLimitReachedModal({limit:"dialogFiltersChats",tabId:o}):(i.forEach((async e=>{const a=(0,c.Mw)(t,e);a&&await(0,r.t9)("editChatFolder",{id:e,folderUpdate:{...a,pinnedChatIds:a.pinnedChatIds?.filter((t=>t!==s)),includedChatIds:a.includedChatIds.filter((t=>t!==s))}})})),n.forEach((async e=>{const a=(0,c.Mw)(t,e);a&&await(0,r.t9)("editChatFolder",{id:e,folderUpdate:{...a,includedChatIds:a.includedChatIds.concat(s)}})})))})),(0,s.iw)("editChatFolder",((t,e,a)=>{const{id:s,folderUpdate:i}=a,n=(0,c.Mw)(t,s);n&&(0,r.t9)("editChatFolder",{id:s,folderUpdate:{id:s,emoticon:n.emoticon,pinnedChatIds:n.pinnedChatIds,...i}})})),(0,s.iw)("addChatFolder",(async(t,e,a)=>{const{folder:i,tabId:n=(0,C._w)()}=a,{orderedIds:d,byId:c}=t.chatFolders,l=(0,w.M)(t,"dialogFilters");if(Object.keys(c).length>=l)return void e.openLimitReachedModal({limit:"dialogFilters",tabId:n});const u=Math.max(...d||[],o.WSp),{id:h,description:p,...g}=i;if(await(0,r.t9)("editChatFolder",{id:u+1,folderUpdate:{id:u+1,...g}}),!p)return;t=(0,s.Rd)();const{recommended:I}=t.chatFolders;I&&(t={...t,chatFolders:{...t.chatFolders,recommended:I.filter((({id:t})=>t!==h))}},(0,s.R3)(t))})),(0,s.iw)("sortChatFolders",(async(t,e,a)=>{const{folderIds:i}=a;await(0,r.t9)("sortChatFolders",i)&&(t=(0,s.Rd)(),t={...t,chatFolders:{...t.chatFolders,orderedIds:i}},(0,s.R3)(t))})),(0,s.iw)("deleteChatFolder",(async(t,e,a)=>{const{id:s}=a,i=(0,c.Mw)(t,s);e.setActiveChatFolder({activeChatFolder:0},(0,C._w)()),i&&await(0,r.t9)("deleteChatFolder",s)})),(0,s.iw)("toggleChatUnread",((t,e,a)=>{const{id:s}=a,n=(0,c.Z1)(t,s);n&&(n.unreadCount?(0,r.t9)("markMessageListRead",{chat:n,threadId:i._f}):(0,r.t9)("toggleDialogUnread",{chat:n,hasUnreadMark:!n.hasUnreadMark}))})),(0,s.iw)("markTopicRead",((t,e,a)=>{const{chatId:i,topicId:n}=a,o=(0,c.Z1)(t,i);if(!o)return;const l=o.topics?.[n]?.lastMessageId;l&&((0,r.t9)("markMessageListRead",{chat:o,threadId:n,maxId:l}),t=(0,s.Rd)(),t=(0,d.Cn)(t,i,n,{unreadCount:0}),t=(0,d.Xg)(t,i,n,{lastReadInboxMessageId:l}),(0,s.R3)(t))})),(0,s.iw)("openChatByInvite",(async(t,e,a)=>{const{hash:s,tabId:i=(0,C._w)()}=a,n=await(0,r.t9)("openChatByInvite",s);n&&e.openChat({id:n.chatId,tabId:i})})),(0,s.iw)("openChatByPhoneNumber",(async(t,e,a)=>{const{phoneNumber:i,startAttach:n,attach:l,tabId:u=(0,C._w)()}=a;e.openChat({id:o.mzl,tabId:u});const h=await async function(t,e){t=(0,s.Rd)();const a=(0,c.Bk)(t,e);if(a&&!a.isMin)return(0,c.Z1)(t,a.id);const{chat:i,user:n}=await(0,r.t9)("getChatByPhoneNumber",e)||{};return i?(t=(0,s.Rd)(),t=(0,d.a4)(t,i.id,i),(0,s.R3)(t),n&&(t=(0,d.Nq)(t,n.id,n),(0,s.R3)(t)),i):void 0}(t,i);if(!h)return e.openPreviousChat({tabId:u}),void e.showNotification({message:m.Iu("lng_username_by_phone_not_found").replace("{phone}",i),tabId:u});e.openChat({id:h.id,tabId:u}),l&&P(t=(0,s.Rd)(),e,h.id,l,n,u)})),(0,s.iw)("openTelegramLink",((t,e,a)=>{const{url:s,tabId:i=(0,C._w)()}=a,{openChatByPhoneNumber:n,openChatByInvite:r,openStickerSet:d,openChatWithDraft:l,joinVoiceChatByLink:u,showNotification:h,focusMessage:g,openInvoice:I,processAttachBotParameters:f,openChatByUsername:m}=e;if(s.match(o.g$l))return void(0,p.ou)(s);const w=new URL(s.toLowerCase().startsWith("http")?s:`https://${s}`);if(o.LBg.has(w.hostname)&&"/"===w.pathname)return void window.open(w.toString(),"_blank","noopener");const b=(o.LBg.has(w.hostname)?"t.me":w.hostname).split(".");if(b.length>3)return;const y=3===b.length?`${b[0]}/${w.pathname}`:w.pathname,[V,v,R]=y.split("/").filter(Boolean).map((t=>decodeURI(t))),M=Object.fromEntries(w.searchParams);let D;"joinchat"===V&&(D=v);const _=!(!M.hasOwnProperty("startattach")||M.startattach)||M.startattach,S=(0,p.GX)(M.choose);if(V.match(/^\+([0-9]+)(\?|$)/))return void n({phoneNumber:V.substr(1,V.length-1),startAttach:_,attach:M.attach,tabId:i});if((V.startsWith(" ")||V.startsWith("+"))&&(D=V.substr(1,V.length-1)),D)return void r({hash:D,tabId:i});if("addstickers"===V||"addemoji"===V)return void d({stickerSetInfo:{shortName:v},tabId:i});const A=v||void 0,P=R?Number(R):void 0,Z=M.comment?Number(M.comment):void 0;if("share"===V)l({text:(0,p.QH)(M.url,M.text),tabId:i});else if(M.hasOwnProperty("voicechat")||M.hasOwnProperty("livestream"))u({username:V,inviteHash:M.voicechat||M.livestream,tabId:i});else if("c"===V&&A&&P){const e=`-${A}`;if(!(0,c.Z1)(t,e))return void h({message:"Chat does not exist",tabId:i});g({chatId:e,messageId:P,tabId:i})}else V.startsWith("$")?I({slug:V.substring(1),tabId:i}):"invoice"===V?I({slug:v,tabId:i}):_&&S?f({username:V,filter:S,..."string"==typeof _&&{startParam:_},tabId:i}):m({username:V,messageId:P||Number(A),threadId:P?Number(A):void 0,commentId:Z,startParam:M.start,startAttach:_,attach:M.attach,tabId:i})})),(0,s.iw)("acceptInviteConfirmation",(async(t,e,a)=>{const{hash:s,tabId:i=(0,C._w)()}=a,n=await(0,r.t9)("importChatInvite",{hash:s});n&&e.openChat({id:n.id,tabId:i})})),(0,s.iw)("openChatByUsername",(async(t,e,a)=>{const{username:i,messageId:n,commentId:u,startParam:h,startAttach:p,attach:g,threadId:I,tabId:f=(0,C._w)()}=a,m=(0,c.jr)(t,f);if(!u)return!p&&n&&!h&&m?.usernames?.some((t=>t.username===i))?void e.focusMessage({chatId:m.id,threadId:I,messageId:n,tabId:f}):void await async function(t,e,a,i,n,r,d,l,...[u=(0,C._w)()]){t=(0,s.Rd)();const h=(0,c.jr)(t,u);if(d&&!l){const s=await A(t,e,a,u);if(!h||!s)return;return void e.callAttachBot({bot:s,chatId:h.id,..."string"==typeof d&&{startParam:d},tabId:u})}const p=h?.usernames?.some((t=>t.username===a));p||e.openChat({id:o.mzl,tabId:u});const g=await S(t,a);g?(n?e.focusMessage({chatId:g.id,threadId:i,messageId:n,tabId:u}):p||e.openChat({id:g.id,threadId:i,tabId:u}),r&&e.startBot({botId:g.id,param:r}),l&&P(t=(0,s.Rd)(),e,g.id,l,d,u)):p||(e.openPreviousChat({tabId:u}),e.showNotification({message:"User does not exist",tabId:u}))}(t,e,i,I,n,h,p,g,f);const{chatId:w,type:b}=(0,c.Bt)(t,f)||{},y=(0,c.DI)(t,i);if(w&&n&&y&&"thread"===b){const a=(0,c.tZ)(t,w,n);if(a&&a.chatId===w)return void e.focusMessage({chatId:a.chatId,threadId:a.threadId,messageId:u,tabId:f})}if(!n)return;e.openChat({id:o.mzl,tabId:f});const V=await S(t,i);if(!V)return;t=(0,s.Rd)();const v=(0,c.tZ)(t,V.id,n);let R;if(v)R=v.chatId;else{const e=await(0,r.t9)("requestThreadInfoUpdate",{chat:V,threadId:n});if(!e)return;t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(e.users,"id")),(0,s.R3)(t),R=e.discussionChatId}R&&e.focusMessage({chatId:R,threadId:n,messageId:Number(u),tabId:f})})),(0,s.iw)("togglePreHistoryHidden",(async(t,e,a)=>{const{chatId:i,isEnabled:n,tabId:o=(0,C._w)()}=a,c=await Z(t,e,i,o);c&&(t=(0,s.Rd)(),t=(0,d.a4)(t,c.id,{fullInfo:{...c.fullInfo,isPreHistoryHidden:n}}),(0,s.R3)(t),(0,r.t9)("togglePreHistoryHidden",{chat:c,isEnabled:n}))})),(0,s.iw)("updateChatDefaultBannedRights",((t,e,a)=>{const{chatId:s,bannedRights:i}=a,n=(0,c.Z1)(t,s);n&&(0,r.t9)("updateChatDefaultBannedRights",{chat:n,bannedRights:i})})),(0,s.iw)("updateChatMemberBannedRights",(async(t,e,a)=>{const{chatId:i,userId:n,bannedRights:o,tabId:l=(0,C._w)()}=a,u=(0,c.dy)(t,n);if(!u)return;const h=await Z(t,e,i,l);if(!h)return;await(0,r.t9)("updateChatMemberBannedRights",{chat:h,user:u,bannedRights:o}),t=(0,s.Rd)();const p=(0,c.Z1)(t,i);if(!p||!p.fullInfo)return;const{members:g,kickedMembers:I}=p.fullInfo,f=Boolean(o.viewMessages),m=!Object.keys(o).length;t=(0,d.a4)(t,i,{fullInfo:{...p.fullInfo,...g&&f&&{members:g.filter((t=>t.userId!==n))},...g&&!f&&{members:g.map((t=>t.userId===n?{...t,bannedRights:o}:t))},...m&&I&&{kickedMembers:I.filter((t=>t.userId!==n))}}}),(0,s.R3)(t)})),(0,s.iw)("updateChatAdmin",(async(t,e,a)=>{const{chatId:i,userId:n,adminRights:o,customTitle:l,tabId:u=(0,C._w)()}=a,h=(0,c.dy)(t,n);if(!h)return;const p=await Z(t,e,i,u);if(!p)return;await(0,r.t9)("updateChatAdmin",{chat:p,user:h,adminRights:o,customTitle:l});const g=await(0,r.t9)("fetchFullChat",p);if(!g?.fullInfo)return;const{adminMembersById:I}=g.fullInfo,f=!Object.keys(o).length;let m;if(I)if(f){const{[n]:t,...e}=I;m=e}else m={...I,[n]:{...I[n],adminRights:o,customTitle:l}};t=(0,s.Rd)(),t=(0,d.a4)(t,i,{fullInfo:{...g.fullInfo,...m&&{adminMembersById:m}}}),(0,s.R3)(t)})),(0,s.iw)("updateChat",(async(t,e,a)=>{const{chatId:i,title:o,about:l,photo:u,tabId:h=(0,C._w)()}=a,p=(0,c.Z1)(t,i);p&&(t=(0,s.Rd)(),t=(0,d.H9)(t,n.wv.InProgress,h),(0,s.R3)(t),await Promise.all([p.title!==o?(0,r.t9)("updateChatTitle",p,o):void 0,p.fullInfo&&p.fullInfo.about!==l?(0,r.t9)("updateChatAbout",p,l):void 0,u?(0,r.t9)("editChatPhoto",{chatId:i,accessHash:p.accessHash,photo:u}):void 0]),t=(0,s.Rd)(),t=(0,d.H9)(t,n.wv.Complete,h),(0,s.R3)(t))})),(0,s.iw)("updateChatPhoto",(async(t,e,a)=>{const{photo:i,chatId:n,tabId:o=(0,C._w)()}=a,l=(0,c.Z1)(t,n);l&&(t=(0,d.a4)(t,n,{avatarHash:void 0,fullInfo:{...l.fullInfo,profilePhoto:void 0}}),(0,s.R3)(t),await(0,r.t9)("editChatPhoto",{chatId:n,accessHash:l.accessHash,photo:i}),await(0,r.t9)("deleteProfilePhotos",[i]),e.loadFullChat({chatId:n,tabId:o}),e.loadProfilePhotos({profileId:n}))})),(0,s.iw)("deleteChatPhoto",(async(t,e,a)=>{const{photo:i,chatId:n,tabId:o=(0,C._w)()}=a,l=(0,c.Z1)(t,n);if(!l)return;const u=[i];if(l.avatarHash===i.id){const e=l.photos?.[1];e&&u.push(e),t=(0,d.a4)(t,n,{avatarHash:void 0,fullInfo:{...l.fullInfo,profilePhoto:void 0}}),(0,s.R3)(t),await(0,r.t9)("editChatPhoto",{chatId:n,accessHash:l.accessHash,photo:e})}await(0,r.t9)("deleteProfilePhotos",u)&&(e.loadFullChat({chatId:n,tabId:o}),e.loadProfilePhotos({profileId:n}))})),(0,s.iw)("toggleSignatures",((t,e,a)=>{const{chatId:s,isEnabled:i}=a,n=(0,c.Z1)(t,s);n&&(0,r.t9)("toggleSignatures",{chat:n,isEnabled:i})})),(0,s.iw)("loadGroupsForDiscussion",(async t=>{const e=await(0,r.t9)("fetchGroupsForDiscussion");if(!e)return;const a=e.reduce(((t,e)=>(e&&!e.isForum&&(t[e.id]=e),t)),{});t=(0,s.Rd)(),t=(0,d.fZ)(t,a),t={...t,chats:{...t.chats,forDiscussionIds:Object.keys(a)}},(0,s.R3)(t)})),(0,s.iw)("linkDiscussionGroup",(async(t,e,a)=>{const{channelId:i,chatId:n,tabId:o=(0,C._w)()}=a||{},l=(0,c.Z1)(t,i);if(!l)return;const u=await Z(t,e,n,o);if(!u)return;let{fullInfo:h}=u;if(!h){const t=await(0,r.t9)("fetchFullChat",u);if(!t)return;h=t.fullInfo}h.isPreHistoryHidden&&(t=(0,s.Rd)(),t=(0,d.a4)(t,u.id,{fullInfo:{...u.fullInfo,isPreHistoryHidden:!1}}),(0,s.R3)(t),await(0,r.t9)("togglePreHistoryHidden",{chat:u,isEnabled:!1})),(0,r.t9)("setDiscussionGroup",{channel:l,chat:u})})),(0,s.iw)("unlinkDiscussionGroup",(async(t,e,a)=>{const{channelId:i,tabId:n=(0,C._w)()}=a,o=(0,c.Z1)(t,i);if(!o)return;let d;o.fullInfo?.linkedChatId&&(d=(0,c.Z1)(t,o.fullInfo.linkedChatId)),await(0,r.t9)("setDiscussionGroup",{channel:o}),d&&_(t=(0,s.Rd)(),e,d,n)})),(0,s.iw)("setActiveChatFolder",((t,e,a)=>{const{activeChatFolder:s,tabId:i=(0,C._w)()}=a;if(!(s+1>(0,w.M)(t,"dialogFilters")))return window.sessionStorage.setItem("activeChatFolder",s.toString()),(0,b.i)(t,{activeChatFolder:s},i);e.openLimitReachedModal({limit:"dialogFilters",tabId:i})})),(0,s.iw)("resetOpenChatWithDraft",((t,e,a)=>{const{tabId:s=(0,C._w)()}=a||{};return(0,b.i)(t,{requestedDraft:void 0},s)})),(0,s.iw)("loadMoreMembers",(async(t,e,a)=>{const{tabId:i=(0,C._w)()}=a||{},{chatId:n}=(0,c.Bt)(t,i)||{},o=n?(0,c.Z1)(t,n):void 0;if(!o||(0,h.G9)(o))return;const u=o.fullInfo?.members?.length||void 0;if(void 0!==u&&void 0!==o.membersCount&&u>=o.membersCount)return;const p=await(0,r.t9)("fetchMembers",o.id,o.accessHash,"recent",u);if(!p)return;const{members:g,users:I,userStatusesById:f}=p;g&&g.length&&(t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(I,"id")),t=(0,d.zn)(t,f),t=(0,d.iX)(t,o,g),(0,s.R3)(t))})),(0,s.iw)("addChatMembers",(async(t,e,a)=>{const{chatId:i,memberIds:o,tabId:d=(0,C._w)()}=a,l=(0,c.Z1)(t,i),u=o.map((e=>(0,c.dy)(t,e))).filter(Boolean);l&&u.length&&(e.setNewChatMembersDialogState({newChatMembersProgress:n.WB.Loading,tabId:d}),await(0,r.t9)("addChatMembers",l,u),e.setNewChatMembersDialogState({newChatMembersProgress:n.WB.Closed,tabId:d}),_(t=(0,s.Rd)(),e,l,d))})),(0,s.iw)("deleteChatMember",(async(t,e,a)=>{const{chatId:i,userId:n,tabId:o=(0,C._w)()}=a,d=(0,c.Z1)(t,i),l=(0,c.dy)(t,n);d&&l&&(await(0,r.t9)("deleteChatMember",d,l),_(t=(0,s.Rd)(),e,d,o))})),(0,s.iw)("toggleIsProtected",((t,e,a)=>{const{chatId:s,isProtected:i}=a,n=(0,c.Z1)(t,s);n&&(0,r.t9)("toggleIsProtected",{chat:n,isProtected:i})})),(0,s.iw)("setChatEnabledReactions",(async(t,e,a)=>{const{chatId:i,enabledReactions:n,tabId:o=(0,C._w)()}=a,d=(0,c.Z1)(t,i);d&&(await(0,r.t9)("setChatEnabledReactions",{chat:d,enabledReactions:n}),_(t=(0,s.Rd)(),e,d,o))})),(0,s.iw)("loadChatSettings",(async(t,e,a)=>{const{chatId:i}=a,n=(0,c.Z1)(t,i);if(!n)return;const o=await(0,r.t9)("fetchChatSettings",n);if(!o)return;const{settings:u,users:h}=o;t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(h,"id")),t=(0,d.a4)(t,n.id,{settings:u}),(0,s.R3)(t)})),(0,s.iw)("toggleJoinToSend",(async(t,e,a)=>{const{chatId:s,isEnabled:i}=a,n=(0,c.Z1)(t,s);n&&((0,h.ZV)(n)||(0,h.eA)(n))&&await(0,r.t9)("toggleJoinToSend",n,i)})),(0,s.iw)("toggleJoinRequest",(async(t,e,a)=>{const{chatId:s,isEnabled:i}=a,n=(0,c.Z1)(t,s);n&&((0,h.ZV)(n)||(0,h.eA)(n))&&await(0,r.t9)("toggleJoinRequest",n,i)})),(0,s.iw)("openForumPanel",((t,e,a)=>{const{chatId:s,tabId:i=(0,C._w)()}=a;return(0,b.i)(t,{forumPanelChatId:s},i)})),(0,s.iw)("closeForumPanel",((t,e,a)=>{const{tabId:s=(0,C._w)()}=a||{};return(0,b.i)(t,{forumPanelChatId:void 0},s)})),(0,s.iw)("processAttachBotParameters",(async(t,e,a)=>{const{username:i,filter:n,startParam:o,tabId:r=(0,C._w)()}=a,d=await A(t,e,i,r);if(!d)return;t=(0,s.Rd)();const{attachMenu:{bots:c}}=t;if(!c[d.id])return t=(0,b.i)(t,{requestedAttachBotInstall:{bot:d,onConfirm:{action:"requestAttachBotInChat",payload:{bot:d,filter:n,startParam:o}}}},r),void(0,s.R3)(t);e.requestAttachBotInChat({bot:d,filter:n,startParam:o,tabId:r})})),(0,s.iw)("loadTopics",(async(t,e,a)=>{const{chatId:i,force:n}=a,u=(0,c.Z1)(t,i);if(!u)return;if(!n&&u.listedTopicIds&&u.listedTopicIds.length===u.topicsCount)return;const h=!n&&u.listedTopicIds?u.listedTopicIds.reduce(((t,e)=>{const a=u.topics?.[e],s=u.topics?.[t];return a&&(!s||a.lastMessageId<s.lastMessageId)?e:t})):void 0,{id:p,date:g,lastMessageId:I}=h&&u.topics?.[h]||{},f=await(0,r.t9)("fetchTopics",{chat:u,offsetTopicId:p,offsetId:I,offsetDate:g,limit:p?o.C1M:o.SC4});f&&(t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(f.users,"id")),t=(0,d.fZ)(t,(0,l.ee)(f.chats,"id")),t=(0,d.m6)(t,f.messages),t=(0,d.XG)(t,i,f.count,f.topics),t=(0,d.Jr)(t,i,f.topics.map((t=>t.id))),Object.entries(f.draftsById||{}).forEach((([e,a])=>{t=(0,d.pf)(t,i,Number(e),"draft",a?.formattedText),t=(0,d.pf)(t,i,Number(e),"replyingToId",a?.replyingToId)})),Object.entries(f.readInboxMessageIdByTopicId||{}).forEach((([e,a])=>{t=(0,d.Xg)(t,i,Number(e),{lastReadInboxMessageId:a})})),(0,s.R3)(t))})),(0,s.iw)("loadTopicById",(async(t,e,a)=>{const{chatId:i,topicId:n}=a,o=(0,c.Z1)(t,i);if(!o)return;const u=await(0,r.t9)("fetchTopicById",{chat:o,topicId:n});if(u)t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,l.ee)(u.users,"id")),t=(0,d.fZ)(t,(0,l.ee)(u.chats,"id")),t=(0,d.m6)(t,u.messages),t=(0,d.Cn)(t,i,n,u.topic),(0,s.R3)(t);else if("tabId"in a&&a.shouldCloseChatOnError){const{tabId:t=(0,C._w)()}=a;e.openChat({id:void 0,tabId:t})}})),(0,s.iw)("toggleForum",(async(t,e,a)=>{const{chatId:i,isEnabled:n,tabId:o=(0,C._w)()}=a,c=await Z(t,e,i,o);if(!c)return;t=(0,s.Rd)();const l=c.isForum;t=(0,d.a4)(t,i,{isForum:n}),(0,s.R3)(t),await(0,r.t9)("toggleForum",{chat:c,isEnabled:n})||(t=(0,s.Rd)(),t=(0,d.a4)(t,i,{isForum:l}),(0,s.R3)(t))})),(0,s.iw)("toggleParticipantsHidden",(async(t,e,a)=>{const{chatId:i,isEnabled:n}=a,o=(0,c.Z1)(t,i);if(!o)return;const l=o.fullInfo?.areParticipantsHidden;t=(0,d.a4)(t,i,{fullInfo:{...o.fullInfo,areParticipantsHidden:n}}),(0,s.R3)(t),await(0,r.t9)("toggleParticipantsHidden",{chat:o,isEnabled:n})||void 0===l||(t=(0,s.Rd)(),t=(0,d.a4)(t,i,{fullInfo:{...o.fullInfo,areParticipantsHidden:l}}),(0,s.R3)(t))})),(0,s.iw)("createTopic",(async(t,e,a)=>{const{chatId:i,title:n,iconColor:o,iconEmojiId:d,tabId:l=(0,C._w)()}=a,u=(0,c.Z1)(t,i);if(!u)return;(0,c.jU)(t,l).createTopicPanel&&(t=(0,b.i)(t,{createTopicPanel:{chatId:i,isLoading:!0}},l),(0,s.R3)(t));const h=await(0,r.t9)("createTopic",{chat:u,title:n,iconColor:o,iconEmojiId:d});h&&e.openChat({id:i,threadId:h,shouldReplaceHistory:!0,tabId:l}),e.closeCreateTopicPanel({tabId:l})})),(0,s.iw)("deleteTopic",(async(t,e,a)=>{const{chatId:i,topicId:n}=a,o=(0,c.Z1)(t,i);o&&await(0,r.t9)("deleteTopic",{chat:o,topicId:n})&&(t=(0,s.Rd)(),t=(0,d.BK)(t,i,n),(0,s.R3)(t))})),(0,s.iw)("editTopic",(async(t,e,a)=>{const{chatId:i,topicId:n,tabId:o=(0,C._w)(),...l}=a,u=(0,c.Z1)(t,i),h=u?.topics?.[n];u&&h&&((0,c.jU)(t,o).editTopicPanel&&(t=(0,b.i)(t,{editTopicPanel:{chatId:i,topicId:n,isLoading:!0}},o),(0,s.R3)(t)),await(0,r.t9)("editTopic",{chat:u,topicId:n,...l})&&(t=(0,s.Rd)(),t=(0,d.Cn)(t,i,n,l),(0,s.R3)(t),e.closeEditTopicPanel({tabId:o})))})),(0,s.iw)("toggleTopicPinned",((t,e,a)=>{const{chatId:s,topicId:i,isPinned:n,tabId:o=(0,C._w)()}=a,{topicsPinnedLimit:d}=t.appConfig||{},l=(0,c.Z1)(t,s);l&&l.topics&&d&&(n&&Object.values(l.topics).filter((t=>t.isPinned)).length>=d?e.showNotification({message:m.Iu("LimitReachedPinnedTopics",d,"i"),tabId:o}):(0,r.t9)("togglePinnedTopic",{chat:l,topicId:i,isPinned:n}))}))},88422:(t,e,a)=>{a.d(e,{CW:()=>P,EP:()=>v,FF:()=>_,Mt:()=>A,NH:()=>S,o5:()=>V});var s=a(33555),i=a(71226),n=a(11192),o=a(64319),r=a(27225),d=a(25260),c=a(78958),l=a(42431),u=a(56112),h=a(60782),p=a(74753),g=a(77361),I=a(50711),f=a(44271),m=a(65054);const w="data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";let b,C,y;function V(){return v(),Promise.all(Object.values(y).map((t=>{const e=t.src;return t.src=w,t.muted=!0,t.volume=1e-4,t.play().then((()=>{t.pause(),t.volume=1,t.currentTime=0,t.muted=!1,requestAnimationFrame((()=>{t.src=e}))}))})))}function v(){if(y)return;const t=new Audio("./voicechat_join.mp3"),e=new Audio("./voicechat_connecting.mp3");e.loop=!0;const a=new Audio("./voicechat_leave.mp3"),s=new Audio("./voicechat_onallowtalk.mp3"),i=new Audio("./call_busy.mp3"),n=new Audio("./call_connect.mp3"),o=new Audio("./call_end.mp3"),r=new Audio("./call_incoming.mp3");r.loop=!0;const d=new Audio("./call_ringing.mp3");d.loop=!0,y={join:t,allowTalk:s,leave:a,connecting:e,incoming:r,end:o,connect:n,busy:i,ringing:d}}async function R(t,e){const a=await(0,i.t9)("getGroupCall",{call:e});if(!a)return;t=(0,s.Rd)();const n=(0,l.$5)(t,e.id);return t=(0,c.AH)(t,e.id,(0,h.CE)(a.groupCall,["connectionState"]),void 0,n?.isLoaded?void 0:a.groupCall.participantsCount),t=(0,d.Sh)(t,(0,h.ee)(a.users,"id")),t=(0,d.fZ)(t,(0,h.ee)(a.chats,"id")),(0,s.R3)(t),a.groupCall}async function M(t,e,a){const n=await(0,i.t9)("fetchGroupCallParticipants",{call:e,offset:a});n&&(t=(0,s.Rd)(),t=(0,d.Sh)(t,(0,h.ee)(n.users,"id")),t=(0,d.fZ)(t,(0,h.ee)(n.chats,"id")),(0,s.R3)(t))}(0,s.iw)("toggleGroupCallPanel",((t,e,a)=>{const{force:s,tabId:i=(0,m._w)()}=a||{};return(0,f.i)(t,{isCallPanelVisible:"force"in(a||{})?s:!(0,n.jU)(t,i).isCallPanelVisible},i)})),(0,s.iw)("subscribeToGroupCallUpdates",(async(t,e,a)=>{const{subscribed:n,id:o}=a,r=(0,l.$5)(t,o);r&&(n&&(await R(t,r),t=(0,s.Rd)(),await M(t,r)),await(0,i.t9)("toggleGroupCallStartSubscription",{subscribed:n,call:r}))})),(0,s.iw)("createGroupCall",(async(t,e,a)=>{const{chatId:o,tabId:r=(0,m._w)()}=a,d=(0,n.Z1)(t,o);if(!d)return;const l=await(0,i.t9)("createGroupCall",{peer:d});l&&(t=(0,s.Rd)(),t=(0,c.AH)(t,l.id,{...l,chatId:o}),(0,s.R3)(t),e.requestMasterAndJoinGroupCall({id:l.id,accessHash:l.accessHash,tabId:r}))})),(0,s.iw)("createGroupCallInviteLink",(async(t,e,a)=>{const{tabId:s=(0,m._w)()}=a||{},r=(0,l.mU)(t);if(!r||!r.chatId)return;const d=(0,n.Z1)(t,r.chatId);if(!d)return;const c=Boolean((0,u.WS)(d));let{inviteLink:h}=d.fullInfo;c&&(h=await(0,i.t9)("exportGroupCallInvite",{call:r,canSelfUnmute:!1})),h&&((0,o.TE)(h),e.showNotification({message:"Link copied to clipboard",tabId:s}))})),(0,s.iw)("joinVoiceChatByLink",(async(t,e,a)=>{const{username:i,inviteHash:n,tabId:o=(0,m._w)()}=a,d=await(0,r.Co)(t,i);if(!d)return void e.showNotification({message:I.Iu("NoUsernameFound"),tabId:o});t=(0,s.Rd)();const c=await(0,r.ft)(t,e,d,o);c?.groupCall&&e.requestMasterAndJoinGroupCall({id:c.groupCall.id,accessHash:c.groupCall.accessHash,inviteHash:n,tabId:o})})),(0,s.iw)("requestMasterAndJoinGroupCall",((t,e,a)=>{e.requestMasterAndCallAction({action:"joinGroupCall",payload:a,tabId:a.tabId||(0,m._w)()})})),(0,s.iw)("requestMasterAndAcceptCall",((t,e,a)=>{e.requestMasterAndCallAction({action:"acceptCall",payload:void 0,tabId:a?.tabId||(0,m._w)()})})),(0,s.iw)("joinGroupCall",(async(t,e,a)=>{const{chatId:i,id:n,accessHash:o,inviteHash:r,tabId:d=(0,m._w)()}=a;if(!g.Bi)return;if(t.phoneCall)return void e.toggleGroupCallPanel({tabId:d});!function(){const t=new(window.AudioContext||window.webkitAudioContext);b=new Audio,C=t,b.srcObject=D(t),(0,p.Z)(b)}(),v(),P(t=(0,s.Rd)(),e,!0,d);const{groupCalls:{activeGroupCallId:u}}=t;let h=n?(0,l.$5)(t,n):(0,l.Bj)(t,i);h?.id!==u?u?"leaveGroupCall"in e&&e.leaveGroupCall({rejoin:a,tabId:d}):h&&u===h.id?e.toggleGroupCallPanel({tabId:d}):(h||n&&o||(h=await R(t,{id:n,accessHash:o})),h&&(t=(0,s.Rd)(),t=(0,c.AH)(t,h.id,{...h,inviteHash:r},void 0,h.participantsCount+1),t={...t,groupCalls:{...t.groupCalls,activeGroupCallId:h.id}},(0,s.R3)(t),e.toggleGroupCallPanel({force:!1,tabId:d}))):e.toggleGroupCallPanel({tabId:d})})),(0,s.iw)("playGroupCallSound",((t,e,a)=>{const{sound:s}=a;y[s]&&("connecting"!==s&&y.connecting.pause(),"incoming"!==s&&y.incoming.pause(),"ringing"!==s&&y.ringing.pause(),(0,p.Z)(y[s]))})),(0,s.iw)("loadMoreGroupCallParticipants",(t=>{const e=(0,l.mU)(t);e&&M(t,e,e.nextOffset)})),(0,s.iw)("requestMasterAndRequestCall",((t,e,a)=>{e.requestMasterAndCallAction({action:"requestCall",payload:a,tabId:a.tabId||(0,m._w)()})})),(0,s.iw)("requestCall",(async(t,e,a)=>{const{userId:i,isVideo:o,tabId:r=(0,m._w)()}=a;t.phoneCall?e.toggleGroupCallPanel({tabId:r}):(0,n.dy)(t,i)&&(v(),P(t=(0,s.Rd)(),e,o,r),t=(0,s.Rd)(),t={...t,phoneCall:{id:"",state:"requesting",participantId:i,isVideo:o,adminId:t.currentUserId}},(0,s.R3)(t),e.toggleGroupCallPanel({force:!1,tabId:r}))}));const D=t=>{const e=t.createOscillator(),a=e.connect(t.createMediaStreamDestination());return e.start(),new MediaStream([Object.assign(a.stream.getAudioTracks()[0],{enabled:!1})])};function _(){return b}function S(){return C}function A(){b?.pause(),C=void 0,b=void 0}function P(t,e,a,...[s=(0,m._w)()]){a?navigator.mediaDevices.getUserMedia({video:!0}).then((t=>{0===t.getVideoTracks().length?e.showNotification({message:I.Iu("Call.Camera.Error"),tabId:s}):Z(0,e,s)})).catch((()=>{e.showNotification({message:I.Iu("Call.Camera.Error"),tabId:s})})):Z(0,e,s)}function Z(t,e,...[a=(0,m._w)()]){navigator.mediaDevices.getUserMedia({audio:!0}).then((t=>{0===t.getAudioTracks().length&&e.showNotification({message:I.Iu("RequestAcces.Error.HaveNotAccess.Call"),tabId:a})})).catch((()=>{e.showNotification({message:I.Iu("RequestAcces.Error.HaveNotAccess.Call"),tabId:a})}))}},78958:(t,e,a)=>{a.d(e,{AH:()=>r,B6:()=>l,Ic:()=>c,dc:()=>d});var s=a(42431),i=a(60782),n=a(53475),o=a(11192);function r(t,e,a,s,n){const o=Object.values({...t.groupCalls.byId[e]?.participants,...a.participants}).filter((({isLeft:t})=>!t)).reduce(((t,e)=>(t[e.id]=e,t)),{});return{...t,groupCalls:{...t.groupCalls,byId:{...t.groupCalls.byId,[e]:{...t.groupCalls.byId[e],...(0,i.CE)(a,["participantsCount"]),...s&&{participantsCount:t.groupCalls.byId[e].participantsCount+s},...void 0!==n&&{participantsCount:n},participants:o}}}}}function d(t,e){const a=(0,s.$5)(t,e);if(a&&a.chatId){const e=(0,o.Z1)(t,a.chatId);e&&(t=(0,n.a4)(t,a.chatId,{fullInfo:{...e.fullInfo,groupCallId:void 0}}))}return{...t,groupCalls:{...t.groupCalls,byId:{...(0,i.CE)(t.groupCalls.byId,[e.toString()])}}}}function c(t,e,a){return t.groupCalls.activeGroupCallId?r(t,t.groupCalls.activeGroupCallId,e,void 0,a):t}function l(t,e,a,i,n=!1){const o=(0,s.$5)(t,e);return o?r(t,e,{participants:{...o.participants,[a]:{...o.participants[a],...i}}},i.isLeft?n?0:-1:o.participants[a]||n?0:1):t}},44107:(t,e,a)=>{a.d(e,{Qx:()=>s});let s=function(t){return t[t.CID_AuthLoginReq=1001]="CID_AuthLoginReq",t[t.CID_AuthLoginRes=1002]="CID_AuthLoginRes",t[t.CID_AuthNativeReq=1003]="CID_AuthNativeReq",t[t.CID_AuthNativeRes=1004]="CID_AuthNativeRes",t[t.CID_AuthPreLoginReq=1005]="CID_AuthPreLoginReq",t[t.CID_AuthPreLoginRes=1006]="CID_AuthPreLoginRes",t[t.CID_AuthStep1Req=1007]="CID_AuthStep1Req",t[t.CID_AuthStep1Res=1008]="CID_AuthStep1Res",t[t.CID_AuthStep2Req=1009]="CID_AuthStep2Req",t[t.CID_AuthStep2Res=1010]="CID_AuthStep2Res",t[t.CID_UpdateProfileReq=1011]="CID_UpdateProfileReq",t[t.CID_UpdateProfileRes=1012]="CID_UpdateProfileRes",t[t.CID_UpdateUsernameReq=1013]="CID_UpdateUsernameReq",t[t.CID_UpdateUsernameRes=1014]="CID_UpdateUsernameRes",t[t.CID_UploadProfilePhotoReq=1015]="CID_UploadProfilePhotoReq",t[t.CID_UploadProfilePhotoRes=1016]="CID_UploadProfilePhotoRes",t[t.CID_LoadChatsReq=2001]="CID_LoadChatsReq",t[t.CID_LoadChatsRes=2002]="CID_LoadChatsRes",t[t.CID_DownloadReq=3001]="CID_DownloadReq",t[t.CID_DownloadRes=3002]="CID_DownloadRes",t[t.CID_UploadReq=3003]="CID_UploadReq",t[t.CID_UploadRes=3004]="CID_UploadRes",t[t.CID_AnswerCallbackButtonReq=4001]="CID_AnswerCallbackButtonReq",t[t.CID_AnswerCallbackButtonRes=4002]="CID_AnswerCallbackButtonRes",t[t.CID_DownloadMsgReq=4003]="CID_DownloadMsgReq",t[t.CID_DownloadMsgRes=4004]="CID_DownloadMsgRes",t[t.CID_GenMsgIdReq=4005]="CID_GenMsgIdReq",t[t.CID_GenMsgIdRes=4006]="CID_GenMsgIdRes",t[t.CID_MsgDeleteReq=4007]="CID_MsgDeleteReq",t[t.CID_MsgDeleteRes=4008]="CID_MsgDeleteRes",t[t.CID_MsgListReq=4009]="CID_MsgListReq",t[t.CID_MsgListRes=4010]="CID_MsgListRes",t[t.CID_MsgUpdateReq=4011]="CID_MsgUpdateReq",t[t.CID_MsgUpdateRes=4012]="CID_MsgUpdateRes",t[t.CID_RemoveMessagesReq=4013]="CID_RemoveMessagesReq",t[t.CID_RemoveMessagesRes=4014]="CID_RemoveMessagesRes",t[t.CID_SendReq=4015]="CID_SendReq",t[t.CID_SendRes=4016]="CID_SendRes",t[t.CID_UploadMsgReq=4017]="CID_UploadMsgReq",t[t.CID_UploadMsgRes=4018]="CID_UploadMsgRes",t[t.CID_OtherNotify=5001]="CID_OtherNotify",t[t.CID_SyncReq=6001]="CID_SyncReq",t[t.CID_SyncRes=6002]="CID_SyncRes",t[t.CID_DownloadUserReq=7001]="CID_DownloadUserReq",t[t.CID_DownloadUserRes=7002]="CID_DownloadUserRes",t[t.CID_GenUserIdReq=7003]="CID_GenUserIdReq",t[t.CID_GenUserIdRes=7004]="CID_GenUserIdRes",t[t.CID_UploadUserReq=7005]="CID_UploadUserReq",t[t.CID_UploadUserRes=7006]="CID_UploadUserRes",t}({})},31275:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.Auth.AuthNativeReq",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_AuthNativeReq),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},73245:(t,e,a)=>{a(82752),a(44107)},85878:(t,e,a)=>{a(82752),a(44107)},32361:(t,e,a)=>{a(82752),a(44107)},23999:(t,e,a)=>{a(82752),a(44107)},11239:(t,e,a)=>{a(82752),a(44107)},70416:(t,e,a)=>{a(82752),a(44107)},65628:(t,e,a)=>{a.d(e,{Yw:()=>s.Z}),a(77729),a(50043);var s=a(31275);a(73805),a(90845),a(62333),a(76598),a(69910),a(84917),a(1249),a(73245),a(85878),a(32361),a(23999),a(11239),a(70416)},79659:(t,e,a)=>{a(82752),a(44107)},93844:(t,e,a)=>{a(82752),a(44107)},53579:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.Msg.DownloadMsgReq",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_DownloadMsgReq),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},84227:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.Msg.DownloadMsgRes",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_DownloadMsgRes),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},21547:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.Msg.GenMsgIdReq",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_GenMsgIdReq),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},87238:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.Msg.GenMsgIdRes",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_GenMsgIdRes),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},27049:(t,e,a)=>{a(82752),a(44107)},40809:(t,e,a)=>{a(82752),a(44107)},59298:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.Msg.UploadMsgReq",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_UploadMsgReq),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},94400:(t,e,a)=>{a.d(e,{Bw:()=>n.Z,IY:()=>s.Z,P5:()=>r.Z,cw:()=>i.Z,qK:()=>o.Z}),a(79659),a(93844);var s=a(53579),i=a(84227),n=a(21547),o=a(87238),r=(a(48011),a(42407),a(27049),a(40809),a(2214),a(58529),a(15230),a(85374),a(50823),a(16178),a(59298));a(60219)},83371:(t,e,a)=>{a.d(e,{Z:()=>n});var s=a(82752),i=a(44107);class n extends s.ZP{constructor(t){var e,a,s;super("PTP.User.DownloadUserReq",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(i.Qx.CID_DownloadUserReq),this.msg=t}static parseMsg(t){return(new n).decode(t.body())}}},67844:(t,e,a)=>{a.d(e,{Sl:()=>i.Z,U0:()=>n.Z,bL:()=>s.Z});var s=a(83371),i=a(63360),n=(a(14879),a(3552),a(80086));a(88320)},22948:(t,e,a)=>{a.d(e,{Z:()=>b});var s=a(4183),i=a(11192),n=a(25260),o=a(60054),r=a(33555),d=a(8454),c=a(2133),l=a(94400),u=a(67844),h=a(93968),p=a(83579),g=a(65628),I=a(69432),f=a(44567),m=a(21591);a(83716);const w={controllers:{},addController(t,e,a){const s=this.key(t,e);return this.controllers[s]=a,s},stop(t,e){const a=this.key(t,e),s=this.controllers[a];console.log(s),s?.abort()},remove(t,e){const a=this.key(t,e);delete this.controllers[a]},key:(t,e)=>`${t},${e}`};class b{constructor(t){var e,a,s;e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msgDispatcher"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.msgDispatcher=t}static async sendText(t,e){const a=await s.Z.genMsgId();s.Z.newMessage(t,a,{chatId:t,id:a,senderId:t,isOutgoing:!1,date:(0,c.q9)(),content:{text:{text:e}}})}static async clearHistory(t){let e=(0,r.Rd)();const a=e.messages.byChatId[t],o=Object.keys(a.byId).map(Number),d=(0,i.Z1)(e,t);return s.Z.apiUpdate({"@type":"deleteMessages",chatId:t,ids:o}),setTimeout((()=>{e=(0,r.Rd)(),e=(0,n.a4)(e,t,{...d,unreadCount:0,lastMessage:s.Z.buildMsgHistoryClear(t)}),(0,r.R3)(e)}),500),!0}async showMnemonic(){await this.msgDispatcher.sendOutgoingMsg(),await this.msgDispatcher.replyText("显示成功"),(0,r.Sv)().updateGlobal({showMnemonicModal:!0})}async setAuth(){await this.msgDispatcher.sendOutgoingMsg();const t=p.Z.getInstance(p.Z.genAccountId()),e=new h.Z("control combine high meat erode catalog public tumble rebel benefit upon public").toEntropy();await t.setEntropy(e);const a=t.getAccountId();p.Z.setCurrentAccountId(a);const s=t?.getSession();if(s)await this.msgDispatcher.replyCode(s);else{const{password:e}=await(0,I.G)();if(e){const a=(0,f.n)(e),s=+new Date,{address:i,sign:n}=await t.signMessage(s.toString(),a),o=p.Z.formatSession({address:i,sign:n,ts:s});t.saveSession(o);const r=await t.getEntropy(),c=t.getAccountId();await(0,d.g)(new g.Yw({accountId:c,entropy:r,session:o}).pack()),await this.msgDispatcher.replyText("账户设置成功"),await this.msgDispatcher.replyCode(o),await this.msgDispatcher.replyCode(r),await this.msgDispatcher.replyCode(c.toString())}}}async genMnemonic(){await this.msgDispatcher.sendOutgoingMsg();const t=new h.Z;return await this.msgDispatcher.replyNewTextMessage({text:t.getWords()})}async downloadBots(t){let e=(0,r.Rd)();const a=(0,i.dy)(e,t);return await this.msgDispatcher.sendOutgoingMsg(),await(0,d.g)(new u.bL({userIds:[a.id]}).pack()),await this.msgDispatcher.replyNewTextMessage({text:"正在下载"}),!0}async uploadBots(t){let e=(0,r.Rd)();const a=(0,i.dy)(e,t);await this.msgDispatcher.sendOutgoingMsg();const s=[],n=[a?.id];for(let a=0;a<n.length&&!(a>0);a++){const o=n[a];s.push({time:(0,c.q9)(),userId:o,user:(0,i.dy)(e,t)})}await(0,d.g)(new u.U0({users:s,time:(0,c.q9)()}).pack());const o=await(p.Z.getCurrentAccount()?.getEntropy());return await this.msgDispatcher.replyNewTextMessage({text:o}),!0}async uploadMessages(t,e){let a=(0,r.Rd)();const s=a.messages.byChatId[t],n=Object.keys(s.byId).map(Number);await this.msgDispatcher.sendOutgoingMsg();const o=[];for(let e=0;e<n.length&&!(e>0);e++){const s=n[e];o.push({time:(0,c.q9)(),messageId:s,message:(0,i.hj)(a,t,s)})}return await(0,d.g)(new l.P5({messages:o,chatId:t,time:(0,c.q9)()}).pack()),await this.msgDispatcher.replyNewTextMessage({text:`正在上传.. ${n.length}`}),!0}async reloadCommands(){let t=(0,r.Rd)(),e=(0,i.dy)(t,this.msgDispatcher.getChatId());const a=e?.fullInfo?.botInfo;if(a){const a=o.Jw.map((t=>({...t,botId:e?.id})));t=(0,n.Nq)(t,e?.id,{...e,fullInfo:{...e?.fullInfo,botInfo:{...e?.fullInfo.botInfo,commands:a}}}),(0,r.R3)(t),t=(0,r.Rd)();const s=(0,i.Z1)(t,this.msgDispatcher.getChatId());return e=(0,i.dy)(t,s?.id),await this.msgDispatcher.sendOutgoingMsg(),await this.msgDispatcher.replyNewTextMessage({text:"重载成功"}),!0}}async setting(){const t=this.msgDispatcher.getChatId();await this.msgDispatcher.sendOutgoingMsg(),await m.Z.setting(t)}static async requestUploadImage(t,e,a,s){}static async answerCallbackButton(t,e,a,s){if(await m.Z.answerCallbackButton(t,e,a,s),s.startsWith("requestChatStream/stop/")){const[t,e]=s.replace("requestChatStream/stop/","").split("/").map(Number);w.stop(t,e)}}static async onUploadFolder(){}async temp(){await this.msgDispatcher.sendOutgoingMsg(),await this.msgDispatcher.sendNewMessage({text:{text:"test"}},{inlineButtons:[[{data:"1",text:"callback button",type:"callback"}],[{text:"command button",type:"command"},{text:"unsupported button",type:"unsupported"},{text:"buy button",type:"buy"}],[{text:"game button",type:"game"},{text:"requestPhone button",type:"requestPhone"}],[{text:"receipt button",type:"receipt",receiptMessageId:1}],[{text:"url button",type:"url",url:"http://www.ai.com"}],[{text:"simpleWebView button",type:"simpleWebView",url:"http://www.ai.com"},{text:"webView button",type:"webView",url:"http://www.ai.com"}],[{text:"requestPoll button",type:"requestPoll",isQuiz:!0},{text:"switchBotInline button",type:"switchBotInline",query:"",isSamePeer:!1},{text:"userProfile button",type:"userProfile",userId:o.gg}],[{text:"requestUploadImage button",type:"requestUploadImage"}]],senderId:this.msgDispatcher.getChatId()}),await this.msgDispatcher.focusLastMessage()}}},21591:(t,e,a)=>{a.d(e,{Z:()=>v});var s=a(4183),i=a(11192),n=a(25260),o=a(60054),r=a(33555),d=a(8454),c=a(2133),l=a(94400),u=a(67844),h=a(93968),p=a(83579),g=a(65628),I=a(69432),f=a(44567),m=a(82752),w=a(44107);class b extends m.ZP{constructor(t){var e,a,s;super("PTP.Sync.SyncReq",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(w.Qx.CID_SyncReq),this.msg=t}static parseMsg(t){return(new b).decode(t.body())}}class C extends m.ZP{constructor(t){var e,a,s;super("PTP.Sync.SyncRes",t),e=this,s=void 0,(a=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(a="msg"))in e?Object.defineProperty(e,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[a]=s,this.setCommandId(w.Qx.CID_SyncRes),this.msg=t}static parseMsg(t){return(new C).decode(t.body())}}var y=a(22948);let V;class v{static async setting(t){const e=p.Z.getCurrentAccount(),a=e?.getSession(),i=await s.Z.genMsgId();s.Z.newMessage(t,i,{chatId:t,id:i,senderId:t,isOutgoing:!1,date:(0,c.q9)(),content:{text:{text:"设置面板"}},inlineButtons:v.getInlineButtons(t,!!a)})}static getInlineButtons(t,e){return e?[[{data:`${t}/setting/uploadFolder`,text:"上传对话",type:"callback"},{data:`${t}/setting/downloadFolder`,text:"下载对话",type:"callback"}],[{data:`${t}/setting/uploadMessages`,text:"上传消息",type:"callback"},{data:`${t}/setting/downloadMessages`,text:"下载消息",type:"callback"}],[{data:`${t}/setting/getSession`,text:"获取session",type:"callback"}],[{data:`${t}/setting/showMnemonic`,text:"showMnemonic",type:"callback"},{data:`${t}/setting/setMnemonic`,text:"setMnemonic",type:"callback"}],[{data:`${t}/setting/disableSync`,text:"关闭同步",type:"callback"},{data:`${t}/setting/cancel`,text:"取消",type:"callback"}]]:[[{data:`${t}/setting/enableSync`,text:"开启同步",type:"callback"},{data:`${t}/setting/cancel`,text:"取消",type:"callback"}]]}static async answerCallbackButton(t,e,a,i){switch(i){case`${e}/setting/getSession`:const n=p.Z.getCurrentAccount(),o=await(n?.getEntropy()),c=h.Z.fromEntropy(o);await y.Z.sendText(e,n?.getSession()),await y.Z.sendText(e,o),await y.Z.sendText(e,c.getWords());break;case`${e}/setting/setMnemonic`:const l=prompt("setMnemonic");if(l){const t=new h.Z(l);if(t.checkMnemonic()){await y.Z.sendText(e,t.toEntropy());const{password:a}=await(0,I.G)();if(a){const s=t.toEntropy();let i=p.Z.getAccountIdByEntropy(s);i||(i=p.Z.genAccountId());const n=p.Z.getInstance(i);p.Z.setCurrentAccountId(i),await(n?.setEntropy(s,!0));const o=(0,f.n)(a),r=+new Date,{address:c,sign:l}=await n.signMessage(r.toString(),o),u=p.Z.formatSession({address:c,sign:l,ts:r});n.saveSession(u),await(0,d.g)(new g.Yw({accountId:i,entropy:t.toEntropy(),session:u}).pack()),await y.Z.sendText(e,u),window.location.reload()}}else await y.Z.sendText(e,"mnemonic 不合法")}break;case`${e}/setting/uploadFolder`:await v.syncFolders(!0);break;case`${e}/setting/downloadFolder`:await v.syncFolders(!1);break;case`${e}/setting/syncMessage`:(0,r.Sv)().updateGlobal({showPickBotModal:!0});break;case`${e}/setting/uploadMessages`:case`${e}/setting/downloadMessages`:V=i,(0,r.Sv)().updateGlobal({showPickBotModal:!0});break;case`${e}/setting/showMnemonic`:(0,r.Sv)().updateGlobal({showMnemonicModal:!0});break;case`${e}/setting/cancel`:s.Z.updateMessage(e,a,{inlineButtons:[]});break;case`${e}/setting/disableSync`:await v.disableSync(t,e,a);break;case`${e}/setting/enableSync`:const{password:u}=await(0,I.G)();u||s.Z.updateMessage(e,a,{inlineButtons:[]}),await v.enableSync(t,e,a,u)}}static buildDefaultChat(t){return{id:t.id,title:t.firstName,type:"chatTypePrivate",isMuted:!1,isMin:!1,hasPrivateLink:!1,isSignaturesShown:!1,isVerified:!0,isJoinToSend:!0,isJoinRequest:!0,lastMessage:{id:0,chatId:t.id,isOutgoing:!1,date:Math.ceil(+new Date/1e3),content:{action:{type:"chatCreate",text:""}}},isForum:!1,isListed:!0,settings:{isAutoArchived:!1,canReportSpam:!1,canAddContact:!1,canBlockContact:!1},accessHash:""}}static async syncFolders(t){let e=(0,r.Rd)();const a=e.chats.byId,s=Object.keys(a).filter((t=>"1"!==t)),o=e.chatIdsDeleted;console.log("local",{chatIds:s,chatIdsDeleted:o});const l=t?{time:(0,c.q9)(),chatFolders:JSON.stringify(e.chatFolders),chatIds:s,chatIdsDeleted:o}:void 0,h=await(0,d.g)(new b({userStoreData:l}).pack()),p=C.parseMsg(h.pdu);let g=[];if(t){for(let t=0;t<s.length;t++){const a=s[t];g.push({time:(0,c.q9)(),userId:a,user:(0,i.dy)(e,a)})}await(0,d.g)(new u.U0({users:g,time:(0,c.q9)()}).pack())}if(p.userStoreData){const{chatFolders:t,...a}=p.userStoreData;if(a.chatIdsDeleted?.forEach((t=>{o.includes(t)||o.push(t)})),console.log("remote",a),a.chatIds){const i=await(0,d.g)(new u.bL({userIds:a.chatIds}).pack());if(i){const a=u.Sl.parseMsg(i?.pdu);if(console.log("downloadUserRes",a),e=(0,r.Rd)(),a.users){const t={},i={};for(let r=0;r<a.users.length;r++){const{user:d}=a.users[r];o.includes(d.id)||(s.includes(d.id)?e=(0,n.Nq)(e,d.id,d):(t[d.id]=d,i[d.id]=v.buildDefaultChat(d)),Object.keys(t).length>0&&(e=(0,n.Sh)(e,t),e=(0,n.fZ)(e,i)))}}(0,r.R3)({...e,chatIdsDeleted:o||[],chatFolders:JSON.parse(t)})}}else(0,r.Sv)().updateGlobal({chatIdsDeleted:o||[],chatFolders:JSON.parse(t)})}(0,r.Sv)().showNotification({message:"更新成功"})}static async enableSync(t,e,a,i){const n=p.Z.getCurrentAccount(),o=(0,f.n)(i),c=+new Date,{address:l,sign:u}=await n.signMessage(c.toString(),o),h=p.Z.formatSession({address:l,sign:u,ts:c});n.saveSession(h);const I=await n.getEntropy(),m=n.getAccountId();await(0,d.g)(new g.Yw({accountId:m,entropy:I,session:h}).pack()),s.Z.updateMessage(e,a,{inlineButtons:[]}),(0,r.Sv)().showNotification({message:"开启成功"}),setTimeout((()=>window.location.reload()),500)}static async disableSync(t,e,a){const i=p.Z.getCurrentAccount();i?.delSession(),s.Z.updateMessage(e,a,{inlineButtons:[]}),await(0,d.g)(new g.Yw({accountId:i.getAccountId(),entropy:await i.getEntropy(),session:void 0}).pack()),(0,r.Sv)().showNotification({message:"关闭成功"}),setTimeout((()=>window.location.reload()),500)}static async onSelectSyncBot(t){const e=V,a=!e?.endsWith("downloadMessages");V=void 0,await y.Z.sendText(o.gg,e);let n=(0,r.Rd)();if(a){const e=(0,i.Zw)(n,t),a=[];if(e)for(let t=0;t<Object.keys(e).length;t++){const s=parseInt(Object.keys(e)[t]);a.push({time:(0,c.q9)(),message:e[s],messageId:s})}a.length>0&&(await(0,d.g)(new l.P5({messages:a,chatId:t,time:(0,c.q9)()}).pack())||(0,r.Sv)().showNotification({message:"更新失败"}))}else{const e=await(0,d.g)(new l.IY({chatId:t}).pack());if(e){const{err:a,messages:o}=l.cw.parseMsg(e?.pdu);if(console.log("messages",o),o)for(let e=0;e<o?.length;e++){const{message:a,messageId:r}=o[e];(0,i.hj)(n,t,r)?s.Z.updateMessage(t,r,a):s.Z.newMessage(t,r,a)}}else(0,r.Sv)().showNotification({message:"更新失败"})}}}},4183:(t,e,a)=>{a.d(e,{Z:()=>l});var s=a(33555),i=a(8454),n=a(2133),o=a(94400),r=a(22948),d=a(6137);function c(t,e,a){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var s=a.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class l{constructor(t,e){c(this,"params",void 0),c(this,"global",void 0),c(this,"msgCommand",void 0),this.global=t,this.params=e,this.msgCommand=new r.Z(this)}static apiUpdate(t){const{apiUpdate:e}=(0,s.Sv)();e(t)}getMsgSenderAsId(){return this.params.sendAs?.id}getMsgText(){return this.params.text}getChatId(){return this.params.chat.id}genMsgDate(){return Math.ceil(+new Date/1e3)}static async genMsgId(t){const{pdu:e}=await(0,i.g)(new o.Bw({isLocal:!!t}).pack()),{messageId:a}=o.qK.parseMsg(e);return a}updateMessageSendSucceeded(t,e){l.apiUpdate({"@type":"updateMessageSendSucceeded",localId:t,chatId:this.params.chat.id,message:e})}updateMessageText(t,{text:e},a){this.updateMessage(t,{...a,content:{...a.content,text:{...a.content.text,text:e}}})}updateMessage(t,e){return l.updateMessage(this.getChatId(),t,e)}static updateMessage(t,e,a){return l.apiUpdate({"@type":"updateMessage",id:e,chatId:t,message:a}),a}static newMessage(t,e,a){return l.apiUpdate({"@type":"newMessage",chatId:t,id:e,message:a,shouldForceReply:!1}),a}async sendNewMessage(t,e){const{isLocalMessageId:a,senderId:s,inlineButtons:i}=e||{},n=await l.genMsgId(!!a),o={id:n,content:t,inlineButtons:i,chatId:this.getChatId(),date:this.genMsgDate(),senderId:this.getMsgSenderAsId(),isOutgoing:(s||this.getMsgSenderAsId())!==this.getChatId(),sendingState:void 0};return l.newMessage(this.getChatId(),n,o)}async sendNewTextMessage({text:t,options:e}){const a=function(t){const e=/```(.*?)\n([\s\S]*?)```/g;t.indexOf("```")>=0&&t.split("```").length%2==0&&(t+="```");let a,s=t,i=[],n=0,o=0;for(;a=e.exec(t);)i.push({type:d.Vv.Pre,language:a[1],offset:a.index-6*n-o,length:a[2].length}),o+=a[1].length+1,s=s.replace(a[0],a[2]),++n;return{text:s.endsWith("```")?s.substring(0,s.indexOf("```")):s,entities:i}}(t);return await this.sendNewMessage({text:a},e)}async replyText(t){return await this.replyNewTextMessage({text:t})}async replyCode(t){return await this.replyNewTextMessage({text:"```\n"+t+"```"})}async replyNewTextMessage({text:t,options:e}){return this.focusLastMessage(200),await this.sendNewTextMessage({text:t,options:{...e,senderId:this.getChatId()}})}async sendOutgoingMsg(){return this.focusLastMessage(100),await this.sendNewTextMessage({text:this.getMsgText()})}static buildMsgHistoryClear(t){return{id:0,chatId:t,isOutgoing:!1,date:(0,n.q9)(),content:{action:{text:"历史记录已清空",type:"historyClear",translationValues:[]}}}}async processCmd(){switch(this.getMsgText()){case"/reloadCommands":case"/start":return await this.msgCommand.reloadCommands();case"/clearHistory":return await r.Z.clearHistory(this.getChatId());case"/temp":return await this.msgCommand.temp();case"/setting":return await this.msgCommand.setting()}}focusLastMessage(t=500){}async process(){let t;return this.getMsgText()?.startsWith("/")&&(t=this.processCmd()),t}}},8454:(t,e,a)=>{a.d(e,{g:()=>o});var s=a(71226),i=a(82752),n=a(48764).Buffer;async function o(t){const e=await(0,s.t9)("sendWithCallback",n.from(t.getPbData()));return e?{pdu:new i.es(n.from(e))}:void 0}},2133:(t,e,a)=>{function s(t,e,a,s){return t.substring(0,e)+s+t.substring(e+a)}a.d(e,{Ju:()=>i,i5:()=>s,k1:()=>n,q9:()=>o});const i=t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t);function n(t){const e=t.replace(/#/g,"?"),a=new URL(e),s=Array.from(a.searchParams.entries()).reduce(((t,[e,a])=>({...t,[e]:a})),{});return{url:a,query:s}}function o(){return Math.ceil(+new Date/1e3)}}}]);
//# sourceMappingURL=8422.332e0cc56d510065d817.js.map